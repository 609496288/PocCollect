# 漏洞详情

## 漏洞简介

Oracle Fusion Middleware中的Oracle WebLogic Server组件的WLS Security子组件存在安全漏洞。使用精心构造的xml数据可能造成任意代码执行，攻击者只需要发送精心构造的xml恶意数据，就可以拿到目标服务器的权限。

## 漏洞影响范围

Weblogic Server 10.3.6.0.0,
Weblogic Server 12.1.3.0.0,
Weblogic Server 12.2.1.1.0,
Weblogic Server 12.2.1.2.0

## 基础补充

在我们动态分析以前，首先引入一个东西XMLDecoder。XMLDecoder 类用于读取使用 XMLEncoder 创建的 XML 文档，用途类似于 ObjectInputStream。当构造恶意的xml时，使用XMLEncoder解析，进行反序列化时，将会触发命令执行。

## 漏洞分析

首先请求先会进入handel方法，handel方法又会执行super.handle(var1, var2, var3);方法，这个方法对servlet的容器和request和response进行了封装。

继续跟进。

发现先会对var1的内容判断是否为空，不为空的话，会取出xml中的header。

然后将获取的header传入readHeaderOld方法。 跟进readHeaderOld方法，发现将hander中的数据以字节流的形式传给WorkContextXmlInputAdapter

WorkContextXmlInputAdapter对象会将传入的xml恶意数据转化为XMLDecoder，对他进行反序列化后就会代码执行。

继续跟进，发现在weblogic.workarea.spi. WorkContextEntryImpl中的readEntry方法中，对var0进行了readUTF()方法。

而var0就是XMLDecoder对象。继续跟进readUTF方法

发现最终执行了readObject方法，对XMLDecoder对象进行了反序列化，导致了远程命令执行。

## 漏洞POC

参见CVE-2017-3056

## 漏洞复现

(1) 安装受影响的Weblogic版本；

(2) 执行POC进行验证。

    python3 cve-2017-3056.py http://192.168.1.1:7001

## 修复方案

(1) 升级Oracle 10月份补丁（四月补丁会触发CVE-2017-10271）

(2) 对访问wls-wsat的资源进行访问控制
